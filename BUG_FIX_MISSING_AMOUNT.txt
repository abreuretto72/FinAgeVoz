# üêõ BUG FIX: Valor Ausente em Transa√ß√µes

## üî¥ PROBLEMA IDENTIFICADO

Quando o usu√°rio n√£o menciona o valor na transa√ß√£o, a IA:
1. ‚ùå Define `amount: 0.0`
2. ‚ùå Define `isPaid: true` (deveria ser `false` quando valor est√° ausente)
3. ‚ùå Coloca o valor dito posteriormente no t√≠tulo da transa√ß√£o

### **Exemplo do Bug:**
```
Usu√°rio: "Gastei no mercado"
IA: Retorna {"amount": 0.0, "isPaid": true, "description": "Mercado"}
IA: Pergunta "Qual o valor?"
Usu√°rio: "150"
Sistema: Registra como PENDENTE com t√≠tulo "Mercado 150"
```

---

## ‚úÖ CORRE√á√ÉO NECESS√ÅRIA

### **Regra Nova:**
Quando `amount` for ausente ou `0.0`, a IA deve:
1. ‚úÖ Retornar `amount: null` (n√£o `0.0`)
2. ‚úÖ Adicionar campo `missing_amount: true`
3. ‚úÖ **N√ÉO** criar a transa√ß√£o ainda
4. ‚úÖ Pedir o valor ao usu√°rio
5. ‚úÖ Quando o valor for informado, criar como `isPaid: true` (se era despesa realizada)

---

## üìù IMPLEMENTA√á√ÉO

### **1. Atualizar Prompt da IA (ai_service.dart)**

**Localiza√ß√£o:** Linhas 426-428

**ANTES:**
```dart
"Comprei um t√™nis hoje" -> {"intent": "ADD_TRANSACTION", "transaction": {"description": "T√™nis", "amount": 0.0, "isExpense": true, "isPaid": true, "date": "$currentDate"}}
"Paguei a conta de luz" -> {"intent": "ADD_TRANSACTION", "transaction": {"description": "Conta de Luz", "amount": 0.0, "isExpense": true, "isPaid": true, "date": "$currentDate"}}
```

**DEPOIS:**
```dart
"Comprei um t√™nis hoje" -> {"intent": "SLOT_FILLING", "entity": "TRANSACTION", "missing_field": "amount", "partial_data": {"description": "T√™nis", "isExpense": true, "isPaid": true, "date": "$currentDate"}, "question": "Qual foi o valor do t√™nis?"}
"Paguei a conta de luz" -> {"intent": "SLOT_FILLING", "entity": "TRANSACTION", "missing_field": "amount", "partial_data": {"description": "Conta de Luz", "isExpense": true, "isPaid": true, "date": "$currentDate"}, "question": "Qual foi o valor da conta de luz?"}
```

### **2. Adicionar Handler de SLOT_FILLING (voice_controller.dart)**

**Adicionar novo m√©todo:**
```dart
Future<void> handleSlotFilling(Map<String, dynamic>? data) async {
  if (data == null) return;
  
  final entity = data['entity'];
  final missingField = data['missing_field'];
  final partialData = data['partial_data'];
  final question = data['question'];
  
  // Armazenar dados parciais
  _pendingTransaction = partialData;
  _missingField = missingField;
  
  // Perguntar ao usu√°rio
  await _voiceService.speak(question);
  
  // Aguardar resposta (pr√≥ximo comando de voz)
  _waitingForSlotValue = true;
}

// Modificar processVoiceCommand para tratar resposta de slot
Future<void> processVoiceCommand(String text) async {
  if (_waitingForSlotValue && _missingField == 'amount') {
    // Extrair valor da resposta
    final value = _extractValue(text);
    if (value != null) {
      _pendingTransaction['amount'] = value;
      _waitingForSlotValue = false;
      _missingField = null;
      
      // Criar transa√ß√£o com dados completos
      await handleTransaction(_pendingTransaction);
      _pendingTransaction = null;
      return;
    }
  }
  
  // Processar normalmente...
}

double? _extractValue(String text) {
  // Regex para extrair n√∫meros
  final regex = RegExp(r'(\d+(?:[.,]\d{1,2})?)');
  final match = regex.firstMatch(text);
  if (match != null) {
    final valueStr = match.group(1)!.replaceAll(',', '.');
    return double.tryParse(valueStr);
  }
  return null;
}
```

### **3. Atualizar handleTransaction**

**Adicionar valida√ß√£o:**
```dart
Future<void> handleTransaction(Map<String, dynamic>? data) async {
  if (data == null) return;
  
  try {
     await _dbService.init();
     
     final description = data['description'] ?? "Transa√ß√£o por Voz";
     final amount = (data['amount'] as num?)?.toDouble();
     
     // VALIDA√á√ÉO: Se amount √© null ou 0, n√£o criar transa√ß√£o
     if (amount == null || amount == 0.0) {
       print("ERROR: Amount is missing. This should have been caught by SLOT_FILLING.");
       await _voiceService.speak("Desculpe, n√£o consegui identificar o valor. Por favor, tente novamente.");
       return;
     }
     
     // Continuar com a cria√ß√£o...
```

---

## üéØ FLUXO CORRIGIDO

### **Cen√°rio 1: Valor Ausente**
```
Usu√°rio: "Gastei no mercado"

IA processa:
- Detecta descri√ß√£o: "Mercado"
- Detecta tipo: DESPESA (verbo "gastei")
- Detecta status: PAGO (verbo passado)
- Detecta valor: AUSENTE

IA responde:
{
  "intent": "SLOT_FILLING",
  "entity": "TRANSACTION",
  "missing_field": "amount",
  "partial_data": {
    "description": "Mercado",
    "isExpense": true,
    "isPaid": true,
    "date": "2025-12-19"
  },
  "question": "Qual foi o valor gasto no mercado?"
}

Sistema:
- Armazena dados parciais
- Fala: "Qual foi o valor gasto no mercado?"
- Aguarda resposta

Usu√°rio: "150"

Sistema:
- Extrai valor: 150.0
- Completa dados: amount = 150.0
- Cria transa√ß√£o: isPaid = true (mant√©m status original)
- Fala: "Despesa de 150 reais registrada com sucesso."
```

### **Cen√°rio 2: Valor Presente**
```
Usu√°rio: "Gastei 150 no mercado"

IA processa:
- Descri√ß√£o: "Mercado"
- Valor: 150.0
- Tipo: DESPESA
- Status: PAGO

IA responde:
{
  "intent": "ADD_TRANSACTION",
  "transaction": {
    "description": "Mercado",
    "amount": 150.0,
    "isExpense": true,
    "isPaid": true,
    "date": "2025-12-19"
  }
}

Sistema:
- Cria transa√ß√£o imediatamente
- Fala: "Despesa de 150 reais registrada com sucesso."
```

---

## üìã CHECKLIST DE IMPLEMENTA√á√ÉO

- [ ] Atualizar exemplos no prompt da IA (ai_service.dart linhas 426-428)
- [ ] Adicionar intent `SLOT_FILLING` ao processVoiceCommand
- [ ] Criar m√©todo `handleSlotFilling`
- [ ] Adicionar vari√°veis de estado: `_pendingTransaction`, `_missingField`, `_waitingForSlotValue`
- [ ] Implementar `_extractValue` para extrair n√∫meros da resposta
- [ ] Adicionar valida√ß√£o em `handleTransaction` para rejeitar amount = 0
- [ ] Testar cen√°rios:
  - [ ] "Gastei no mercado" ‚Üí Pergunta valor ‚Üí "150" ‚Üí Registra como PAGO
  - [ ] "Comprei um t√™nis" ‚Üí Pergunta valor ‚Üí "200" ‚Üí Registra como PAGO
  - [ ] "Gastei 150 no mercado" ‚Üí Registra imediatamente como PAGO

---

**Criado em:** 19/12/2024  
**Prioridade:** ALTA  
**Autor:** Antigravity AI
